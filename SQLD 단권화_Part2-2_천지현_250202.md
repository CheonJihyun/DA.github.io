# PART 2 SQL 기본 및 활용

## CHAPTER 2 SQL 활용

### 1. 서브쿼리(Subquery)

#### 서브쿼리

- 하나의 SQL문 안에 포함된 또 다른 SQL문
- 반드시 괄호로 묶어야

#### 서브쿼리 사용 가능한 위치

- SELECT절, FROM절, WHERE절, HAVING절, ORDER BY절, 기타 DML(INSERT, DELETE, UPDATE)절
- <span color='red'>GROUP BY절 사용 불가</span>

#### 서브쿼리 종류

- 동작하는 방식에 따라: 비연관 서브쿼리(메인쿼리 값 참조 X), 연관 서브쿼리(메인쿼리의 각 행에 대해 서브쿼리 실행)
- 위치에 따라: 스칼라 서브쿼리(SELECT절, 결과를 하나의 컬럼처럼 사용, JOIN의 대체 연산), 인라인뷰(FROM절, 결과를 테이블처럼 사용), WHERE절 서브쿼리
- WHERE절 서브쿼리 종류: 단일행 서브쿼리(서브쿼리 결과가 1개 행, 기본 비교연산자 사용 가능), 다중행 서브쿼리(다중행 서브쿼리 연산자 사용해야), 다중컬럼 서브쿼리(대소비교 불가), 상호연관 서브쿼리(메인쿼리와 서브쿼리 간의 비교, 메인쿼리는 서브쿼리를 모르기 때문에 서브쿼리에 작성해줘야)
- 단일행 서브쿼리 연산자: =, <>, >, >=, <, <=
- 다중행 서브쿼리 연산자: IN, >ANY, <ANY, <ALL, >ALL, EXISTS, NOT EXISTS
- 다중컬럼 서브쿼리 연산자: IN(비교대상과 서브쿼리의 SELECT절을 순서 맞춰서 작성해줘야)

#### 서브쿼리 주의사항

- 특별한 경우(TOP-N 분석 등)를 제외하고는 서브쿼리에 ORDER BY 사용 불가
- 서브쿼리 종류에 따른 연산자 선택이 중요

### 2. 뷰(View)

### 3. 집합 연산자

#### 집합 연산자

- SELECT문 결과를 하나의 집합으로 간주, 그 집합에 대한 합집합, 교집합, 차집합 연산
- SELECT문과 SELECT문 사이에 집합 연산자 정의
- 두 집합의 컬럼이 동일하게 구성되어야 함(컬럼의 데이터 타입과 순서 일치해야)
- 전체 집합의 데이터타입과 컬럼명은 첫번째 집합에 의해 결정

#### 합집합

- UNION: 중복된 데이터를 한 번만 출력, 중복된 데이터 제거를 위해 내부적으로 정렬 수행하므로 중복된 데이터가 없으면 UNION ALL 사용(불필요한 정렬 X)
- UNION ALL: 중복된 데이터도 전체 출력

#### 교집합

- INTERSECT: 공통된 행 출력

#### 차집합

- MINUS: 한 쪽 집합에만 존재하는 행 출력, 집합의 순서 주의

#### 집합 연산자 사용시 주의사항

- 컬럼 수 일치해야
- 컬럼 순서 일치해야
- 각 컬럼의 데이터 타입 일치해야
- 각 컬럼의 사이즈는 달라도 됨
- 개별 SELECT 문에 ORDER BY 전달 불가(GROUP BY는 가능)

### 4. 그룹 함수

#### 그룹 함수

- 숫자 함수 중 여러 값을 전달하여 하나의 요약 값을 출력하는 다중행 함수
- 수학/통계 함수(기술통계 함수)
- GROUP BY 절에 의해 그룹별 연산 결과를 리턴
- 반드시 한 컬럼만 전달
- NULL은 무시하고 연산

#### COUNT

- 테이블의 행의 수를 세는 함수
- 인수: * 또는 하나의 표현식
- 문자, 숫자, 날짜 컬럼 모두 가능
- NULL은 세지 않음
- COUNT(*)는 항상 모든 행의 수를 출력

#### SUM

- 숫자만 전달 가능

#### AVG

- 숫자만 전달 가능
- NULL 제외

#### VARIANCE / STDDEV

- 분산과 표준편차

#### GROUP BY FUNCTION

- GROUP BY 절에 사용하는 함수
- 여러 GROUP BY 결과를 동시에 출력(합집합)하는 기능 -> UNION ALL로 대체 가능
- GROUPING SETS(그룹 연산 결과 출력, 나열 순서 중요 X, 총계 출력 X -> NULL 또는 () 추가해서 출력 가능), ROLLUP(A별, (A,B)별, 전체 총 계 출력 -> 나열 순서 중요), CUBE(A별, B별, (A,B)별, 전체 총 계 출력 -> 나열 순서 중요 X)

### 5. 윈도우 함수

#### WINDOW FUNCTION

- 서로 다른 행의 비교나 연산을 위해 만든 함수
- GROUP BY 쓰지 않고 그룹 연산 가능
- LAG, LEAD, SUM, AVG, MIN, MAX, COUNT, RANK

#### 윈도우 함수 문법

SELECT 윈도우함수([대상])
OVER (
  [PARTITION BY 컬럼]
  [ORDER BY 컬럼 ASC|DESC]
  [ROWS|RANGE BETWEEN A AND B]
)

- 순서 중요 (ORDER BY를 PARTITION BY 전에 사용 불가)
- PARTITION BY 절: 출력할 총 데이터 수 변화 없이 그룹연산 수행할 GROUP BY 컬럼
- ORDER BY 절: RANK의 경우 필수, SUM/AVG/MIN/MAX/COUNT 등은 누적값 출력 시 사용
- ROWS|RANGE BETWEEN A AND B: 연산 범위 설정, ORDER BY절 필수

#### 그룹 함수 형태

- SUM/AVG/MIN/MAX() OVER () <- PARTITION, 누적합 안할거면 OVER 부분은 ()으로 쓰면 됨
- 서브쿼리를 써도 되지만 윈도우 함수 쓰면 1-depth로 해결 가능

#### 윈도우 함수 연산 대상 및 범위 (ROWS|RANGE BETWEEN A AND B)

- 연산 대상: ROWS(연산할 행 지정), RANGE(연산할 값의 범위 지정) <- 차이 잘 알아야
- 범위: A(시작점, CURRENT ROW(현재 행부터), UNBOUNDED PRECEDING(처음부터, DEFAULT), N PRECEDING(N 이전부터)), B(마지막 지점, CURRNET ROW(현재 범위까지, DEFAULT), UNBOUNDED FOLLOWING(마지막까지), N FOLLOWING(N 이후까지))
- 특징: BETWEEN A: AND B 생략 가능 = B는 DEFAULT인 CURRENT ROW 적용

#### 순위 관련 함수

RANK
- RANK WITHIN GROUP: 특정 값에 대한 순위 확인, 윈도우 함수 X
- RANK() OVER(): 전체 중/특정 그룹 중 값의 순위 확인, ORDER BY절 필수, 순위 구할 대상을 ORDER BY 절에 명시, 그룹 내 순위 구할 시 PARTITION BY절 사용, 동순위 있으면 그 개수만큼 띄우고 다음 순위로 출력
- DENSE_RANK: 누적 순위, 동순위 있어도 다음 순위 바로 이어지는 순위 부여 방식
- ROW_NUMBER: 연속된 행 번호, 동순위 인정 X -> 나열된 순서 값 리턴

#### LAG, LEAD

- 행 순서대로 각각 이전 값(LAG), 이후 값(LEAD) 가져오기
- ORDER BY 절 필수

#### FIRST_VALUE, LAST_VALUE

- 정렬 순서대로 정해진 범위에서의 처음 값, 마지막 값 출력
- 순서와 범위 정의에 따라 최솟값, 최댓값 둘 다 리턴 가능
- PARTITION BY, ORDER BY절 생략 가능

#### NTILE

- 행을 특정 컬럼 순서에 따라 정해진 수의 그룹으로 나누기 위한 함수
- 그룹 번호 리턴됨
- ORDER BY절 필수
- PARTITION BY 사용해서 특정 그룹을 원하는 수 만큼 그룹 분리 가능
- 그룹 별 행 수가 동일하게 나눠지지 않을 경우 앞 그룹의 크기가 더 크도록 분리됨

#### 비율 관련 함수

- RATIO_TO_REPORT: 각 값이 전체 합에서 차지하는 비율 계산, ORDER BY 사용 불가
- 

### 6. Top-N 쿼리

### 7. 셀프 조인(Self Join)

### 8. 계층 쿼리

### 9. PIVOT 절과 UNPIVOT 절

### 10. 정규표현식
